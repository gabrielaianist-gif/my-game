<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sobrevivência 3D - Vila dos Pinheiros</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #crosshair { 
            position: absolute; top: 50%; left: 50%; 
            width: 10px; height: 10px; 
            border: 2px solid rgba(255,255,255,0.8); 
            border-radius: 50%; 
            transform: translate(-50%, -50%); 
            pointer-events: none; z-index: 20; 
        }
        #ui { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            color: white; text-align: center; 
            text-shadow: 2px 2px 10px rgba(0,0,0,0.8); 
            z-index: 10; cursor: pointer; 
        }
        #hud { 
            position: absolute; bottom: 20px; left: 20px; 
            color: white; font-size: 1.2rem; 
            text-shadow: 2px 2px 4px #000; 
        }
        .instructions-box {
            background: rgba(0,0,0,0.6);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #555;
        }
    </style>
</head>
<body>

    <div id="ui">
        <div class="instructions-box">
            <h1>VILA DOS PINHEIROS 3D</h1>
            <p>CLIQUE PARA INICIAR</p>
            <small>WASD: Mover | Mouse: Olhar | Clique: Atirar</small>
        </div>
    </div>

    <div id="crosshair"></div>
    <div id="hud">Inimigos: <span id="count">0</span> | Vida do Alvo: <span id="hp">---</span></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- CONFIGURAÇÃO DA CENA ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // Céu azul
        scene.fog = new THREE.FogExp2(0x87CEEB, 0.02);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- ILUMINAÇÃO ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const sun = new THREE.DirectionalLight(0xffffff, 1.0);
        sun.position.set(10, 20, 10);
        sun.castShadow = true;
        scene.add(sun);

        // --- CHÃO ---
        const groundGeo = new THREE.PlaneGeometry(200, 200);
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x2d4c1e });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // --- CRIAÇÃO DA ARMA (.38) ---
        const gunGroup = new THREE.Group();
        const metalMat = new THREE.MeshStandardMaterial({ color: 0x222222, metalness: 0.8, roughness: 0.2 });
        const woodMat = new THREE.MeshStandardMaterial({ color: 0x3d2b1f });

        // Cano
        const barrel = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.02, 0.4), metalMat);
        barrel.rotation.x = Math.PI / 2;
        barrel.position.z = -0.2;
        
        // Tambor
        const drum = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.12), metalMat);
        drum.rotation.x = Math.PI / 2;
        
        // Cabo
        const grip = new THREE.Mesh(new THREE.BoxGeometry(0.04, 0.15, 0.08), woodMat);
        grip.position.set(0, -0.1, 0.05);
        grip.rotation.x = 0.2;

        gunGroup.add(barrel, drum, grip);
        gunGroup.position.set(0.3, -0.25, -0.5); // Posição na mão do jogador
        camera.add(gunGroup);
        scene.add(camera);

        // Flash do Tiro (Luz)
        const muzzleFlash = new THREE.PointLight(0xffaa00, 0, 3);
        muzzleFlash.position.set(0.3, -0.2, -0.8);
        camera.add(muzzleFlash);

        // --- ÁRVORES E INIMIGOS ---
        const enemies = [];
        const treeColliders = [];

        function createTree(x, z) {
            const tree = new THREE.Group();
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 3), new THREE.MeshStandardMaterial({color: 0x4d2902}));
            trunk.position.y = 1.5;
            const leaves = new THREE.Mesh(new THREE.ConeGeometry(1.5, 4, 8), new THREE.MeshStandardMaterial({color: 0x113311}));
            leaves.position.y = 4;
            tree.add(trunk, leaves);
            tree.position.set(x, 0, z);
            scene.add(tree);
            treeColliders.push({x, z, radius: 0.8});
        }

        function spawnEnemy(x, z) {
            const enemy = new THREE.Group();
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.3, 1, 4, 8), new THREE.MeshStandardMaterial({color: 0x333333}));
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.25, 8, 8), new THREE.MeshStandardMaterial({color: 0xdbac82}));
            head.position.y = 0.8;
            enemy.add(body, head);
            enemy.position.set(x, 1, z);
            enemy.userData = { health: 100 };
            scene.add(enemy);
            enemies.push(enemy);
        }

        // Gerar Floresta e Inimigos
        for(let i=0; i<30; i++) createTree(Math.random()*80-40, Math.random()*80-40);
        for(let i=0; i<10; i++) spawnEnemy(Math.random()*60-30, Math.random()*60-30);

        // --- MOVIMENTO E CONTROLES ---
        let isLocked = false;
        const keys = {};
        const raycaster = new THREE.Raycaster();

        document.addEventListener('click', () => {
            if(!isLocked) renderer.domElement.requestPointerLock();
        });

        document.addEventListener('pointerlockchange', () => {
            isLocked = document.pointerLockElement === renderer.domElement;
            document.getElementById('ui').style.display = isLocked ? 'none' : 'block';
        });

        document.addEventListener('keydown', (e) => keys[e.code] = true);
        document.addEventListener('keyup', (e) => keys[e.code] = false);

        // Sistema de Olhar (Mouse)
        document.addEventListener('mousemove', (e) => {
            if (isLocked) {
                camera.rotation.y -= e.movementX * 0.002;
                camera.rotation.x -= e.movementY * 0.002;
                camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
            }
        });

        // Sistema de Tiro
        window.addEventListener('mousedown', () => {
            if (!isLocked) return;

            // Recoil Visual
            gunGroup.position.z += 0.08;
            muzzleFlash.intensity = 5;
            setTimeout(() => muzzleFlash.intensity = 0, 50);

            // Raycast (Mira)
            raycaster.setFromCamera(new THREE.Vector2(), camera);
            const intersects = raycaster.intersectObjects(enemies, true);

            if (intersects.length > 0) {
                let hitObj = intersects[0].object;
                while(hitObj.parent && !hitObj.userData.health) hitObj = hitObj.parent;

                hitObj.userData.health -= 10;
                document.getElementById('hp').innerText = hitObj.userData.health;

                // Feedback visual de dano
                hitObj.traverse(c => { if(c.isMesh) c.material.emissive.setHex(0xff0000) });
                setTimeout(() => hitObj.traverse(c => { if(c.isMesh) c.material.emissive.setHex(0x000000) }), 100);

                if (hitObj.userData.health <= 0) {
                    scene.remove(hitObj);
                    enemies.splice(enemies.indexOf(hitObj), 1);
                    document.getElementById('hp').innerText = "MORTO";
                }
            }
        });

        // --- LOOP DE ANIMAÇÃO ---
        function animate() {
            requestAnimationFrame(animate);

            if (isLocked) {
                const speed = 0.12;
                const oldPos = camera.position.clone();

                if (keys['KeyW']) camera.translateZ(-speed);
                if (keys['KeyS']) camera.translateZ(speed);
                if (keys['KeyA']) camera.translateX(-speed);
                if (keys['KeyD']) camera.translateX(speed);
                
                camera.position.y = 1.6; // Altura dos olhos

                // Colisão com árvores
                for (let tree of treeColliders) {
                    const dist = Math.sqrt((camera.position.x - tree.x)**2 + (camera.position.z - tree.z)**2);
                    if (dist < tree.radius) camera.position.copy(oldPos);
                }

                // Suavização do Coice da Arma
                gunGroup.position.z += (-0.5 - gunGroup.position.z) * 0.1;
                
                // Inimigos encaram o jogador
                enemies.forEach(en => en.lookAt(camera.position.x, 1, camera.position.z));
            }

            document.getElementById('count').innerText = enemies.length;
            renderer.render(scene, camera);
        }

        camera.rotation.order = 'YXZ';
        animate();

        // Ajuste de tela
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>